# ElasticSearch

http通信端口 9200
tcp通信端口 9300

## 安装


## 1.1.1. 介绍

Elasticsearch（ES）是一个基于Lucene构建的开源、分布式、RESTful接口的全文搜索引擎。

Elasticsearch还是一个分布式文档数据库，其中每个字段均可被索引，而且每个字段的数据均可被搜索，ES能够横向扩展至数以百计的服务器存储以及处理PB级的数据。可以在极短的时间内存储、搜索和分析大量的数据。通常作为具有复杂搜索场景情况下的核心发动机。

## 1.1.2. 应用

* 当你经营一家网上商店，你可以让你的客户搜索你卖的商品。在这种情况下，你可以使用ElasticSearch来存储你的整个产品目录和库存信息，为客户提供精准搜索，可以为客户推荐相关商品。

* 当你想收集日志或者交易数据的时候，需要分析和挖掘这些数据，寻找趋势，进行统计，总结，或发现异常。在这种情况下，你可以使用Logstash或者其他工具来进行收集数据，当这引起数据存储到ElasticsSearch中。你可以搜索和汇总这些数据，找到任何你感兴趣的信息。

* 对于程序员来说，比较有名的案例是GitHub，GitHub的搜索是基于ElasticSearch构建的，在github.com/search页面，你可以搜索项目、用户、issue、pull request，还有代码。共有40~50个索引库，分别用于索引网站需要跟踪的各种数据。虽然只索引项目的主分支（master），但这个数据量依然巨大，包括20亿个索引文档，30TB的索引文件。

## 1.1.3. 基本概念

* Near Realtime(NRT) 几乎实时

  Elasticsearch是一个几乎实时的搜索平台。意思是，从索引一个文档到这个文档可被搜索只需要一点点的延迟，这个时间一般为毫秒级

* Cluster 集群

  群集是一个或多个节点（服务器）的集合， 这些节点共同保存整个数据，并在所有节点上提供联合索引和搜索功能。

* Node节点

  节点是单个服务器实例，它是群集的一部分，可以存储数据，并参与群集的索引和搜索功能。

* Index索引

  索引是具有相似特性的文档集合。例如，可以为客户数据提供索引，为产品目录建立另一个索引，以及为订单数据建立另一个索引。索引由名称（必须全部为小写）标识，该名称用于在对其中的文档执行索引、搜索、更新和删除操作时引用索引。在单个群集中，你可以定义尽可能多的索引。

* Type类型

  在索引中，可以定义一个或多个类型。类型是索引的逻辑类别/分区，其语义完全取决于你。一般来说，类型定义为具有公共字段集的文档。例如，假设你运行一个博客平台，并将所有数据存储在一个索引中。在这个索引中，你可以为用户数据定义一种类型，为博客数据定义另一种类型，以及为注释数据定义另一类型。

* Document文档

  文档是可以被索引的信息的基本单位。例如，你可以为单个客户提供一个文档，单个产品提供另一个文档，以及单个订单提供另一个文档。本文件的表示形式为JSON（JavaScript Object Notation）格式，这是一种非常普遍的互联网数据交换格式。

  在索引/类型中，你可以存储尽可能多的文档。请注意，尽管文档物理驻留在索引中，文档实际上必须索引或分配到索引中的类型。

* Shards & Replicas分片与副本

  索引可以存储大量的数据，这些数据可能超过单个节点的硬件限制。例如，十亿个文件占用磁盘空间1TB的单指标可能不适合对单个节点的磁盘或可能太慢服务仅从单个节点的搜索请求。

  为了解决这一问题，Elasticsearch提供细分你的指标分成多个块称为分片的能力。当你创建一个索引，你可以简单地定义你想要的分片数量。每个分片本身是一个全功能的、独立的“指数”，可以托管在集群中的任何节点。

  **Shards分片的重要性主要体现在以下两个特征**：

  1. 副本为分片或节点失败提供了高可用性。为此，需要注意的是，一个副本的分片不会分配在同一个节点作为原始的或主分片，副本是从主分片那里复制过来的。

  2. 副本允许用户扩展你的搜索量或吞吐量，因为搜索可以在所有副本上并行执行。

* ES基本概念与关系型数据库的比较

ES概念 | 关系型数据库
:---: | :---:
Index（索引）| 支持全文检索	Database（数据库）
Type（类型）| Table（表）
Document（文档）| 不同文档可以有不同的字段集合	Row（数据行）
Field（字段）| Column（数据列）
Mapping（映射）| Schema（模式）

### 1.1.4. ES API

* #### 查看健康状态

  ```
      curl -X GET 127.0.0.1:9200/_cat/health?v
  ```

* 查询当前es集群中所有的indices

  ```
      curl -X GET 127.0.0.1:9200/_cat/indices?v
  ```

* 创建索引

  ```
      curl -X PUT 127.0.0.1:9200/www
  ```

* 删除索引

  ```
      curl -X DELETE 127.0.0.1:9200/www
  ```

* 插入记录

  ```
  curl -H "ContentType:application/json" -X POST 127.0.0.1:9200/user/person -d '
      {
          "name": "LMH",
          "age": 18,
          "married": true
      }'
  ```

  也可以使用PUT方法，但是需要传入id

  ```
   curl -H "ContentType:application/json" -X PUT 127.0.0.1:9200/user/person/4 -d '
      {
          "name": "LMH",
          "age": 18,
          "married": false
      }'
  ```

* 检索

  ES检索语法比较特别，使用GET方法携带JSON格式的查询条件

  * 全检索：
  
    ```
        curl -X GET 127.0.0.1:9200/user/person/_search
    ```
  
  * 按条件检索：
  
    ```
    curl -H "ContentType:application/json" -X PUT 127.0.0.1:9200/user/person/4 -d '
        {
            "query":{
                "match": {"name": "LMH"}
            }    
        }'
    ```
  
    默认一次最多返回10条结果，可以像下面的示例通过size字段来设置返回结果的数目
  
    ```
    curl -H "ContentType:application/json" -X PUT 127.0.0.1:9200/user/person/4 -d '
        {
            "query":{
                "match": {"name": "LMH"},
                "size": 2
            }    
        }'
    ```
  
    
  
  



